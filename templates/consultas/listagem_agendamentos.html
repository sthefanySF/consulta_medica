{% extends "base.html" %}
{% block title %}Lista de Agendamentos{% endblock %}
{% load static %}

{% block content %}

{% if messages %}{% include 'messages.html' %}{% endif %}

<div class="text-center text-white mb-4">
  <h4>LISTA DE AGENDAMENTOS GERAIS</h4>
</div>

<div class="d-flex justify-content-between align-items-center" id="glass">
  <a class="btn btn-danger" href="{% url 'home' %}" style="margin-bottom: 3px; max-height: 50px; box-shadow: 0px 2px 20px -10px rgb(0, 0, 0);">
    Voltar
  </a>

  <div class="mb-4 d-flex align-items-center" id="" style="margin-left: 60px;">
    <form method="get" class="mx-auto" style="max-width: 600px; min-width: 410px;">
      <div class="row">
        <div class="row align-items-end">
          <div class="col-md-12 mb-3">
            <label for="profissional_saude" class="form-label text-white">Profissional de Saúde:</label>
            <select name="profissional_saude" id="profissional_saude" class="form-select">
              <option value="" selected>Selecione um profissional</option>
              <option value="todos" class="destacado">Listar Todos</option>
              {% for profissional in profissionais_saude %}
                <option value="{{ profissional.id }}" {% if request.GET.profissional_saude == profissional.id|stringformat:"s" %}selected{% endif %}>{{ profissional.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Botão para abrir o Modal -->
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agendamentoModal{{ agendamento.id }}">
    Agendar
</button>
</div>

<div class="table-responsive">
  <table id="example" class="table table-striped nowrap table-bordered" style="width:100%">
    <thead>
      <tr class="custom-table-row">
        <th scope="col" class="text-center">Paciente</th>
        <th scope="col" class="text-center">CPF</th>
        <th scope="col" class="text-center">Profissional de Saúde</th>
        <th scope="col" class="text-center">Data do Agendamento</th>
        <th scope="col" class="text-center">P.A</th>
        <th scope="col" class="text-center">Turno</th>
        <th scope="col" class="text-center">Status</th>
        <th scope="col" class="text-center">Ações</th>
      </tr>
    </thead>

    <tbody>
      {% for agendamento in agendamentos %}
        <tr>
          <td>{{ agendamento.paciente.nome }}</td>
          <td>{{ agendamento.paciente.cpf }}</td>
          <td>{{ agendamento.profissional_saude.nome }}</td>
          <td>{{ agendamento.data_agendamento | date:"d/m/Y " }}</td>
          <td>
            {% if agendamento.prioridade_atendimento %}
              <i class="fa fa-circle text-success text-center"></i>
            {% else %}
              <i class="fa fa-circle text-danger text-center"></i>
            {% endif %}
          </td>

          <td>
            {% if agendamento.turno == 'manha' %}
              Manhã
            {% elif agendamento.turno == 'tarde' %}
              Tarde
            {% else %}
              {{ agendamento.turno }}
            {% endif %}
          </td>

          <td>
            {% if agendamento.status_atendimento == 'pendente' %}
              <div class="btn-group" role="group" aria-label="Status">
                <a href="{% url 'agendamentoConfirmar' agendamento.id %}" class="btn btn-success">Confirmar</a>
              </div>
            {% elif agendamento.status_atendimento == 'confirmado' %}
              Confirmado
            {% elif agendamento.status_atendimento == 'ausente' %}
              Ausente
            {% elif agendamento.status_atendimento == 'atendido' %}
              Atendido
            {% else %}
              Cancelado
            {% endif %}
          </td>

          <td>
            <div class="btn-group" role="group" aria-label="Ações">
              <button type="button" 
                      class="btn btn-secondary ms-1 btn-lg custom-btn" 
                      data-status="{{ agendamento.status_atendimento }}" 
                      data-bs-toggle="modal" 
                      data-bs-target="#reagendarModal{{ agendamento.id }}" 
                      title="Reagendar"
                      {% if agendamento.status_atendimento != 'pendente' %}disabled{% endif %}>
                  <i class="fa fa-calendar-o" aria-hidden="true"></i>
              </button>   

              <button type="button" class="btn btn-danger ms-1 btn-lg custom-btn {% if agendamento.status_atendimento != 'pendente' %}disabled{% endif %}" data-status="{{ agendamento.status_atendimento }}" data-bs-toggle="modal" data-bs-target="#cancelarModal{{ agendamento.id }}" title="Cancelar">
                <i class="fa fa-times" aria-hidden="true"></i>
              </button>
            
              {% if agendamento.status_atendimento == 'confirmado' %}
              <button type="button" 
                      class="btn btn-success ms-1 btn-lg custom-btn" 
                      onclick="redirecionar('{% url 'criar_atendimento' agendamento.id %}')" 
                      title="Atender">
                  <i class="fa fa-check-square-o" aria-hidden="true"></i>
              </button>
              {% else %}
              <button type="button" 
                      class="btn btn-success ms-1 btn-lg custom-btn disabled" 
                      disabled>
                  <i class="fa fa-check-square-o" aria-hidden="true"></i>
              </button>
              {% endif %}           
            
              <button type="button" class="btn btn-info ms-1 btn-lg custom-btn" onclick="redirecionar('{% url 'confirmAgendamento' agendamento.id %}')" title="Visualizar"><i class="fa fa-eye" aria-hidden="true"></i></button>
            </div>

            <!-- Modal para cancelar agendamento -->
            <div class="modal fade" id="cancelarModal{{ agendamento.id }}" tabindex="-1" aria-labelledby="cancelarModalLabel{{ agendamento.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="cancelarModalLabel{{ agendamento.id }}">Cancelar Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>Ao cancelar esse agendamento ele não poderá mais ser atendido. Informe a justificativa para o cancelamento:</p>
                    <textarea id="justificativa_cancelamento_{{ agendamento.id }}" class="form-control" rows="4" placeholder="Digite a justificativa aqui"></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-danger" onclick="cancelarAgendamento({{ agendamento.id }})">Confirmar Cancelamento</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de Reagendamento -->
            <div class="modal fade" id="reagendarModal{{ agendamento.id }}" tabindex="-1" aria-labelledby="reagendarModalLabel{{ agendamento.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="reagendarModalLabel{{ agendamento.id }}">Reagendar Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="reagendarForm{{ agendamento.id }}" method="POST">
                      {% csrf_token %}
                      <div class="mb-3">
                        <label for="profissional_saude">Profissional de Saúde</label>
                        <select id="profissional_saude_{{ agendamento.id }}" name="profissional_saude" class="form-select">
                          {% for profissional in profissionais_saude %}
                            <option value="{{ profissional.id }}" {% if agendamento.profissional_saude.id == profissional.id %}selected{% endif %}>{{ profissional.nome }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="data_agendamento">Data do Agendamento</label>
                        <input type="date" id="data_agendamento_{{ agendamento.id }}" name="data_agendamento" class="form-control" value="{{ agendamento.data_agendamento|date:'Y-m-d' }}">
                      </div>
                      <div class="mb-3">
                        <label for="turno">Turno</label>
                        <select id="turno_{{ agendamento.id }}" name="turno" class="form-select">
                          <option value="manha" {% if agendamento.turno == 'manha' %}selected{% endif %}>Manhã</option>
                          <option value="tarde" {% if agendamento.turno == 'tarde' %}selected{% endif %}>Tarde</option>
                        </select>
                      </div>
                      <div class="mb-3 form-check">
                        <input type="checkbox" id="prioridade_atendimento_{{ agendamento.id }}" name="prioridade_atendimento" class="form-check-input" {% if agendamento.prioridade_atendimento %}checked{% endif %}>
                        <label class="form-check-label" for="prioridade_atendimento_{{ agendamento.id }}">Prioridade de Atendimento</label>
                      </div>
                      <div class="text-center">
                        <button type="button" class="btn btn-primary" onclick="reagendarAgendamento({{ agendamento.id }})">Reagendar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal de Agendamento -->
<div class="modal fade" id="agendamentoModal{{ agendamento.id }}" tabindex="-1" aria-labelledby="agendamentoModalLabel{{ agendamento.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="agendamentoModalLabel{{ agendamento.id }}">Agendamento de Pacientes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="agendamentoForm{{ agendamento.id }}" method="POST" action="{% url 'agendamentoCreate' %}">
          {% csrf_token %}
          <input type="hidden" name="status_atendimento" value="pendente" />

          <!-- Contêiner para mensagens de erro -->
          <div id="formErrors{{ agendamento.id }}" class="alert alert-danger d-none"></div>

          <!-- Campo Paciente -->
          <div class="mb-3">
            <label for="id_paciente" class="form-label"><b>Paciente</b></label>
            {{ form.paciente }}
          </div>

          <!-- Campo Profissional de Saúde -->
          <div class="mb-3">
            <label for="id_profissional_saude" class="form-label"><b>Profissional de Saúde</b></label>
            {{ form.profissional_saude }}
          </div>

          <!-- Campo Data do Agendamento -->
          <div class="mb-3">
            <label for="id_data_agendamento" class="form-label"><b>Data do Agendamento</b></label>
            {{ form.data_agendamento }}
          </div>

          <!-- Campo Turno -->
          <div class="mb-3">
            <label for="id_turno" class="form-label"><b>Turno</b></label>
            {{ form.turno }}
          </div>

          <!-- Campo Prioridade de Atendimento -->
          <div class="mb-3 form-check">
            {{ form.prioridade_atendimento }}
            <label class="form-check-label" for="id_prioridade_atendimento"><b>Prioridade de Atendimento</b></label>
          </div>

          <div class="d-flex justify-content-center align-items-center">
            <button type="submit" class="btn btn-primary" style="margin-right: 10px;"><b>Agendar</b></button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><b>Cancelar</b></button>
          </div>
        </form>
      </div>


    </div>
  </div>

  <!-- Área de Confirmação -->
  <div id="confirmationArea{{ agendamento.id }}" class="confirmation-area d-none mt-4">
    <div class="card mx-auto" style="width: 800px;">
      <div class="card-body">
        <h4>Confirmação de Agendamento</h4>
        <table class="table table-striped table-bordered">
          <tbody>
            <tr>
              <th>Paciente:</th>
              <td id="confirmPaciente{{ agendamento.id }}"></td>
            </tr>
            <tr>
              <th>Profissional de Saúde:</th>
              <td id="confirmProfissionalSaude{{ agendamento.id }}"></td>
            </tr>
            <tr>
              <th>Data do Agendamento:</th>
              <td id="confirmDataAgendamento{{ agendamento.id }}"></td>
            </tr>
            <tr>
              <th>Turno:</th>
              <td id="confirmTurno{{ agendamento.id }}"></td>
            </tr>
            <tr>
              <th>Prioridade de Atendimento:</th>
              <td id="confirmPrioridadeAtendimento{{ agendamento.id }}"></td>
            </tr>
          </tbody>
        </table>
        <div class="d-flex justify-content-between mt-2">
          <a class="btn btn-primary btn-sm" id="downloadComprovante{{ agendamento.id }}" href="#">Baixar Comprovante &nbsp;<i class="fa fa-file-pdf-o" aria-hidden="true"></i></a>
          <button class="btn btn-warning" data-bs-dismiss="modal"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i>&nbsp;Voltar para agendamento</button>
        </div>
      </div>
    </div>
  </div>
</div>


<button onclick="voltarTopo()" id="btnTopo">
  <i id="arrow" class="fa fa-arrow-up fa-lg"></i>
</button>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    new DataTable("#example", {
      responsive: true,
      language: {
        url: '//cdn.datatables.net/plug-ins/2.0.3/i18n/pt-PT.json',
      },
    });
  });

  $(document).ready(function() {
    $('#profissional_saude').change(function() {
      $(this).closest('form').submit();
    });
  });

  function redirecionar(url) {
    window.location.href = url;
  }

  function cancelarAgendamento(agendamentoId) {
    var button = document.querySelector('[data-bs-target="#cancelarModal' + agendamentoId + '"]');
    var status = button.getAttribute('data-status');

    if (status !== 'pendente') {
      alert('Não é possível cancelar um agendamento que não está pendente.');
      return;
    }

    var justificativa = document.getElementById('justificativa_cancelamento_' + agendamentoId).value;

    $.ajax({
      type: 'POST',
      url: '/cancelar_agendamento/' + agendamentoId + '/',
      data: {
        'justificativa': justificativa,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      success: function(response) {
        if (response.success) {
          alert(response.message);
          location.reload();
        } else {
          alert('Erro: ' + response.errors);
        }
      },
      error: function(response) {
        alert('Ocorreu um erro ao cancelar o agendamento.');
      }
    });
  }

  function reagendarAgendamento(agendamentoId) {
    console.log("Reagendando agendamento com ID:", agendamentoId);
    var status = document.querySelector('[data-bs-target="#reagendarModal' + agendamentoId + '"]').getAttribute('data-status');

    if (status !== 'pendente') {
        alert('Este agendamento não pode ser reagendado porque não está pendente.');
        return;
    }

    var form = $('#reagendarForm' + agendamentoId);
    var formData = form.serialize();

    $.ajax({
        type: 'POST',
        url: '/reagendar/agendamento/' + agendamentoId + '/',
        data: formData,
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                var errorContainer = $('#errorContainer' + agendamentoId);
                errorContainer.empty(); // Limpar erros anteriores

                var errors = response.errors;
                var errorMessages = '';
                for (var field in errors) {
                    if (errors.hasOwnProperty(field)) {
                        errors[field].forEach(function(error) {
                            errorMessages += '<p class="text-danger">' + error.message + '</p>';
                        });
                    }
                }
                errorContainer.html(errorMessages);
            }
        },
        error: function(response) {
            alert('Ocorreu um erro ao reagendar o agendamento.');
        }
    });
}
</script>

<script>
  $(document).ready(function() {
      $('form[id^="agendamentoForm"]').on('submit', function(event) {
          event.preventDefault();
  
          var form = $(this);
          var formData = form.serialize();
          var formId = form.attr('id').replace('agendamentoForm', '');
          var formErrorsId = '#formErrors' + formId;
          var submitButton = form.find('button[type="submit"]');
          var originalButtonText = submitButton.html();
  
          submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Agendando...').attr('disabled', true);
  
          $.ajax({
              type: 'POST',
              url: form.attr('action'),
              data: formData,
              success: function(response) {
                  if (response.success) {
                      showConfirmation(response.agendamento, formId);
                      submitButton.html(originalButtonText).attr('disabled', false);
                  } else {
                      showErrorMessages(response.errors, formErrorsId);
                      submitButton.html(originalButtonText).attr('disabled', false);
                  }
              },
              error: function(xhr) {
                  if (xhr.status === 400) {
                      var response = xhr.responseJSON;
                      showErrorMessages(response.errors, formErrorsId);
                  } else {
                      alert('Ocorreu um erro ao agendar.');
                  }
                  submitButton.html(originalButtonText).attr('disabled', false);
              }
          });
      });
  
      function showErrorMessages(errors, formErrorsId) {
          var errorMessages = '';
          var parsedErrors = JSON.parse(errors);
  
          for (var field in parsedErrors) {
              if (parsedErrors.hasOwnProperty(field)) {
                  parsedErrors[field].forEach(function(error) {
                      errorMessages += '<p>' + error.message + '</p>';
                  });
              }
          }
          $(formErrorsId).html(errorMessages).removeClass('d-none');
      }
  
      function showConfirmation(data, id) {
          $('#confirmPaciente' + id).text(data.paciente);
          $('#confirmProfissionalSaude' + id).text(data.profissional_saude);
          $('#confirmDataAgendamento' + id).text(data.data_agendamento);
          $('#confirmTurno' + id).text(data.turno);
          $('#confirmPrioridadeAtendimento' + id).text(data.prioridade_atendimento);
          $('#downloadComprovante' + id).attr('href', data.download_url);
  
          $('#confirmationArea' + id).removeClass('d-none');
      }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const forms = document.querySelectorAll('form[id^="agendamentoForm"]');
    forms.forEach(form => {
        form.addEventListener('submit', function (event) {
            const paciente = form.querySelector('#id_paciente').value;
            const dataAgendamento = form.querySelector('#id_data_agendamento').value;

            if (!paciente || !dataAgendamento) {
                event.preventDefault();
                alert('Por favor, preencha todos os campos obrigatórios.');
            }
        });
    });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const forms = document.querySelectorAll('form[id^="agendamentoForm"]');
    forms.forEach(form => {
        form.addEventListener('submit', function (event) {
            const paciente = form.querySelector('#id_paciente').value;
            const dataAgendamento = form.querySelector('#id_data_agendamento').value;

            if (!paciente || !dataAgendamento) {
                event.preventDefault();
                alert('Por favor, preencha todos os campos obrigatórios.');
            }
        });
    });
});
</script>



<style>
  .dataTables_filter {
    display: flex;
    justify-content: flex-end;
  }
</style>

{% endblock %}
