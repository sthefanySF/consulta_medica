<!-- prontuario_medico.html -->
{% extends 'base.html' %}

{% block title %}
  Prontuário Médico
{% endblock %}

{% block content %}
  <h4 class="text-center mb-4 custom-title">Prontuário Médico de {{ paciente.nome }}</h4>

  <div class="d-flex justify-content-between pb-3">
    <a class="btn btn-primary" href="{% url 'pacienteListagem' %}" style="height: fit-content;">Voltar</a>

    <form id="filtro-form">
      <label class="form-label">Profissionais de Saúde:</label>
      <input type="hidden" name="paciente_id" value="{{ paciente.id }}" />
      <div class="row align-items-end">
        <div class="col-md-12 mb-3" style="width: auto;">
          {% for profissional in profissionais_saude %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="medico{{ profissional.id }}" name="medicos" value="{{ profissional.id }}" />
              <label class="form-check-label" for="medico{{ profissional.id }}">{{ profissional.nome }}</label>
            </div>
          {% endfor %}
          <button class="btn btn-primary">Filtrar</button>
        </div>
      </div>
    </form>

    <a href="{% url 'pdf_prontuario_medico' paciente.id %}?medicos={{ medicos_ids|join:',' }}" target="_blank" class="print-btn" style="border: none;">
      <button class="print-btn">
        <span class="printer-wrapper">
          <span class="printer-container">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 92 75">
              <path stroke-width="5" stroke="black" d="M12 37.5H80C85.2467 37.5 89.5 41.7533 89.5 47V69C89.5 70.933 87.933 72.5 86 72.5H6C4.067 72.5 2.5 70.933 2.5 69V47C2.5 41.7533 6.75329 37.5 12 37.5Z"></path>
              <mask fill="white" id="path-2-inside-1_30_7">
                <path d="M12 12C12 5.37258 17.3726 0 24 0H57C70.2548 0 81 10.7452 81 24V29H12V12Z"></path>
              </mask>
              <path mask="url(#path-2-inside-1_30_7)" fill="black" d="M7 12C7 2.61116 14.6112 -5 24 -5H57C73.0163 -5 86 7.98374 86 24H76C76 13.5066 67.4934 5 57 5H24C20.134 5 17 8.13401 17 12H7ZM81 29H12H81ZM7 29V12C7 2.61116 14.6112 -5 24 -5V5C20.134 5 17 8.13401 17 12V29H7ZM57 -5C73.0163 -5 86 7.98374 86 24V29H76V24C76 13.5066 67.4934 5 57 5V-5Z"></path>
              <circle fill="black" r="3" cy="49" cx="78"></circle>
            </svg>
          </span>

          <span class="printer-page-wrapper"><span class="printer-page"></span></span>
        </span>
        Print
      </button>
    </a>
  </div>

  <dl id="patient-info">
    {% for atendimento in atendimentos %}
      <div id="" class="flex d-flex justify-content-evenly">
        <p>
          <strong>Atendido por Dr(a)</strong><span>{{ atendimento.profissional_saude.nome }}</span>
        </p>
        <p>
          <strong>Tipo de Paciente:</strong><span>{{ paciente.tipo_paciente }}</span>
        </p>
        <p>
          <strong>Data do Atendimento:</strong><span>{{ atendimento.data_atendimento }}</span>
        </p>
      </div>

      <dd id="diag">
        <p>
          <strong>Anamnese:</strong> {{ atendimento.anamnese }}<br />
        </p>
        <p>
          <strong>Exame Físico:</strong> {{ atendimento.exame_fisico }}<br />
        </p>
        <p>
          <strong>Exames Complementares:</strong> {{ atendimento.exames_complementares }}<br />
        </p>
        <p>
          <strong>Diagnóstico:</strong> {{ atendimento.diagnostico }}<br />
        </p>
        <p>
          <strong>Conduta:</strong> {{ atendimento.conduta }}<br />
        </p>
      </dd>
      {% empty %}
      <dt>Nenhum atendimento registrado para este paciente.</dt>
    {% endfor %}
  </dl>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    $(document).ready(function () {
      $('#filtro-form').on('submit', function (e) {
        e.preventDefault()
        $.ajax({
          url: "{% url 'filtrar_prontuarios' %}",
          data: $(this).serialize(),
          success: function (data) {
            console.log(data)
            $('#patient-info').empty()
    
            data.forEach(function (atendimento) {
              console.log('Atendimento:', atendimento)
              if (atendimento) {
                $('#patient-info').append(`
                        <div class="flex d-flex justify-content-evenly">
                          <p><strong>Atendido por Dr(a)</strong><span>${atendimento.profissional_saude}</span></p>
                          <p><strong>Paciente:</strong><span>${atendimento.paciente}</span></p>
                          <p><strong>Data do Atendimento:</strong><span>${atendimento.data_atendimento}</span></p>
                        </div>
                        <dd id="diag">
                          <p><strong>Anamnese:</strong> ${atendimento.anamnese}<br /></p>
                          <p><strong>Exame Físico:</strong> ${atendimento.exame_fisico}<br /></p>
                          <p><strong>Exames Complementares:</strong> ${atendimento.exames_complementares}<br /></p>
                          <p><strong>Diagnóstico:</strong> ${atendimento.diagnostico}<br /></p>
                          <p><strong>Conduta:</strong> ${atendimento.conduta}<br /></p>
                        </dd>
                      `)
              }
            })
          }
        })
      })
    })
  </script>

  <script>
    document.getElementById('filtro-form').addEventListener('submit', function (e) {
      e.preventDefault()
      var medicos = Array.from(document.querySelectorAll('input[name="medicos"]:checked')).map(function (input) {
        return input.value
      })
      var url = "{% url 'pdf_prontuario_medico' paciente.id %}?medicos=" + medicos.join(',')
      document.querySelector('.print-btn').href = url
    })
  </script>

  <style>
    p {
      text-align: justify;
    }
    
    #diag {
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 15px;
    }
    
    #patient-info {
      border: 1px solid #ccc;
      border-radius: 15px;
      padding: 20px;
    }
    
    .print-btn {
      width: 100px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      border: 1px solid rgb(213, 213, 213);
      border-radius: 10px;
      gap: 10px;
      font-size: 16px;
      cursor: pointer;
      overflow: hidden;
      font-weight: 500;
      box-shadow: 0px 10px 10px rgba(0, 0, 0, 0.065);
      transition: all 0.3s;
    }
    .printer-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 100%;
    }
    .printer-container {
      height: 50%;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    
    .printer-container svg {
      width: 100%;
      height: auto;
      transform: translateY(4px);
    }
    .printer-page-wrapper {
      width: 100%;
      height: 50%;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }
    .printer-page {
      width: 70%;
      height: 10px;
      border: 1px solid black;
      background-color: white;
      transform: translateY(0px);
      transition: all 0.3s;
      transform-origin: top;
    }
    .print-btn:hover .printer-page {
      height: 16px;
      background-color: rgb(239, 239, 239);
    }
    .print-btn:hover {
      background-color: rgb(239, 239, 239);
    }
  </style>
{% endblock %}

{% comment %} <style>
  body {
    font-family: 'Poppins', sans-serif;
  }
  
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    border-bottom: 1px solid #afafaf;
  }
  .infoufac {
    font-weight: bold;
    text-align: center;
  }
  
  #logoufac {
    width: 70px;
    height: auto;
  }
  
  span {
    display: flex;
    font-size: 20px;
    font-weight: bold;
    justify-content: center;
    margin-top: 10px;
  }
  .info-prontuario {
  }
  
  .contents {
    display: flex;
    padding: 10px 0 10px 0;
  }
  
  .contents dt {
    font-weight: 600;
  }
  
  .diagnosticos {
    padding: 10px 0 10px 0;
  }
  
  .diagnosticos dt {
    font-weight: 600;
    margin-top: 10px;
  }
  
  .diagnosticos dd {
    border-bottom: solid 1px #afafaf;
  }
  .info-atendimento {
    border: 1px solid #afafaf;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
  }
</style> {% endcomment %}
